# 支付页面字段显示修复 - 测试说明

## 📋 问题说明

**问题编号:** #012  
**严重程度:** 🔴 高  
**问题描述:** 进入支付页面后,乘客人数和支付金额显示为空白

---

## 🐛 问题表现

### 修复前
```
┌─────────────────────────────┐
│ 订单信息                     │
├─────────────────────────────┤
│ 订单号: ORD20251110001      │
│ 航班号: CA1234              │
│ 乘客人数: [空白]  ❌        │
├─────────────────────────────┤
│ 应付金额                     │
│ ¥[空白]  ❌                 │
└─────────────────────────────┘
```

### 修复后
```
┌─────────────────────────────┐
│ 订单信息                     │
├─────────────────────────────┤
│ 订单号: ORD20251110001      │
│ 航班号: CA1234              │
│ 乘客人数: 1 人  ✅          │
├─────────────────────────────┤
│ 应付金额                     │
│ ¥800  ✅                    │
└─────────────────────────────┘
```

---

## 🔍 根本原因

### 数据流分析

```
订单创建 → 订单详情接口 → 支付页面
   ↓              ↓            ↓
字段完整      字段缺失      显示空白
```

### 字段对比表

| 字段名 | 订单创建 | 详情接口(修复前) | 详情接口(修复后) | 支付页面 |
|--------|---------|----------------|----------------|---------|
| passengerCount | ✅ | ❌ | ✅ | ✅ 需要 |
| totalPrice | ✅ | ❌ | ✅ | ✅ 需要 |
| totalAmount | ❌ | ✅ | ✅ | ❌ 不用 |
| price | ❌ | ✅ | ✅ | ❌ 不用 |

---

## 🔧 修复方案

### 修改位置
- **文件:** `mock-data.ts`
- **行号:** 第286-307行
- **接口:** 获取订单详情 `GET /api/orders/:id`

### 修复代码

```typescript
// 转换为前端期望的格式
const formattedOrder = {
  id: order.id,
  orderNo: order.orderNo,
  flightNo: order.flightNo || 'CA1234',
  departureCity: order.departureCity || '南京',
  arrivalCity: order.arrivalCity || '上海',
  departureTime: order.departureTime || '2025-11-10 08:00',
  arrivalTime: order.arrivalTime || '2025-11-10 10:30',
  date: order.date || '2025-11-10',
  status: order.status === 1 ? 'pending' : 
          order.status === 2 ? 'paid' : 
          order.status === 3 ? 'completed' : 'cancelled',
  cabinClass: order.cabinClass || 'economy',
  price: order.totalPrice || 0,
  totalAmount: order.totalPrice || 0,
  totalPrice: order.totalPrice || 0,  // ← 新增:支付页面需要
  passengerCount: order.passengerCount || order.passengers?.length || 1,  // ← 新增:支付页面需要
  passengers: order.passengers || [],
  createTime: order.createTime,
  payTime: order.payTime,
  paymentMethod: order.paymentMethod
}
```

### 关键修改点

1. **添加 totalPrice 字段**
   ```typescript
   totalPrice: order.totalPrice || 0
   ```
   - 用途: 支付页面显示应付金额
   - 来源: 订单创建时的 totalPrice
   - 默认值: 0

2. **添加 passengerCount 字段**
   ```typescript
   passengerCount: order.passengerCount || order.passengers?.length || 1
   ```
   - 用途: 支付页面显示乘客人数
   - 来源: 优先使用订单的 passengerCount,否则计算 passengers 数组长度
   - 默认值: 1

---

## 🧪 测试步骤

### 前置条件
1. 确保开发服务器正在运行
2. 确保 Mock 数据服务正常工作
3. 已登录用户账号

### 测试场景1: 单个乘客订单

**步骤:**
1. 进入首页,搜索航班
2. 选择一个航班,点击"预订"
3. 填写1个乘客信息
4. 提交订单,进入支付页面

**预期结果:**
- ✅ 乘客人数显示: `1 人`
- ✅ 应付金额显示: `¥800` (或实际金额)
- ✅ 订单号正确显示
- ✅ 航班号正确显示

---

### 测试场景2: 多个乘客订单

**步骤:**
1. 进入首页,搜索航班
2. 选择一个航班,点击"预订"
3. 填写3个乘客信息
4. 提交订单,进入支付页面

**预期结果:**
- ✅ 乘客人数显示: `3 人`
- ✅ 应付金额显示: `¥2400` (或实际金额)
- ✅ 金额与乘客人数对应

---

### 测试场景3: 从订单列表进入支付

**步骤:**
1. 进入"我的订单"页面
2. 找到一个"待支付"订单
3. 点击"去支付"按钮

**预期结果:**
- ✅ 乘客人数正确显示
- ✅ 应付金额正确显示
- ✅ 与订单列表中的金额一致

---

### 测试场景4: 边界情况

**测试用例:**

| 情况 | passengerCount | passengers数组 | 预期显示 |
|------|---------------|---------------|---------|
| 正常情况 | 2 | [p1, p2] | 2 人 ✅ |
| 缺少count | undefined | [p1, p2] | 2 人 ✅ |
| 数组为空 | undefined | [] | 1 人 ✅ |
| 都缺失 | undefined | undefined | 1 人 ✅ |

---

## ✅ 验收标准

### 功能验收
- [ ] 单个乘客订单显示正确
- [ ] 多个乘客订单显示正确
- [ ] 从订单列表进入显示正确
- [ ] 边界情况处理正确

### 数据验收
- [ ] 乘客人数不为空
- [ ] 应付金额不为空
- [ ] 金额格式正确(带¥符号)
- [ ] 人数格式正确(带"人"字)

### 兼容性验收
- [ ] 不影响订单列表页面
- [ ] 不影响订单详情页面
- [ ] 不影响支付成功页面
- [ ] 不影响其他订单操作

---

## 📊 测试记录表

| 测试场景 | 测试人 | 测试日期 | 测试结果 | 备注 |
|---------|--------|---------|---------|------|
| 场景1: 单个乘客 | | 2025-11-10 | ⏳ 待测试 | |
| 场景2: 多个乘客 | | 2025-11-10 | ⏳ 待测试 | |
| 场景3: 订单列表进入 | | 2025-11-10 | ⏳ 待测试 | |
| 场景4: 边界情况 | | 2025-11-10 | ⏳ 待测试 | |

---

## 🔗 相关文件

### 修改文件
- `mock-data.ts` - 订单详情接口数据格式

### 相关页面
- `src/views/user/PaymentPage.vue` - 支付页面
- `src/views/user/FlightBookPage.vue` - 预订页面
- `src/views/user/OrdersPage.vue` - 订单列表页

### 相关文档
- `project-testing-and-fixes.md` - 问题修复记录 #012
- `开发记录.md` - 项目开发记录

---

## 💡 技术要点

### 1. 字段兼容性处理
```typescript
// 优先级: 直接字段 > 计算字段 > 默认值
passengerCount: order.passengerCount || order.passengers?.length || 1
```

### 2. 可选链操作符
```typescript
// 安全访问可能不存在的属性
order.passengers?.length
```

### 3. 逻辑或运算符
```typescript
// 提供多层降级方案
value1 || value2 || defaultValue
```

---

## 🎯 影响范围

### 直接影响
- ✅ 支付页面显示正常

### 间接影响
- ✅ 提升用户体验
- ✅ 减少用户困惑
- ✅ 避免支付失败

### 无影响
- ✅ 订单创建流程
- ✅ 订单列表显示
- ✅ 其他页面功能

---

## 📝 注意事项

1. **测试环境**
   - 确保使用最新的代码
   - 清除浏览器缓存
   - 检查控制台是否有错误

2. **数据准确性**
   - 验证金额计算是否正确
   - 验证人数统计是否准确
   - 对比订单列表和支付页面数据

3. **边界情况**
   - 测试空数据情况
   - 测试异常数据情况
   - 测试最大乘客数情况(9人)

---

**测试负责人:** _____________  
**测试日期:** 2025-11-10  
**文档版本:** v1.0  
**修复状态:** ✅ 已修复
