# Bugä¿®å¤: å–æ¶ˆè®¢å•APIç¼ºå¤±

**Bugç¼–å·:** #010  
**ä¿®å¤æ—¥æœŸ:** 2025-11-10  
**ä¸¥é‡ç¨‹åº¦:** ğŸ”´ é«˜ (æ ¸å¿ƒåŠŸèƒ½ç¼ºå¤±)  
**çŠ¶æ€:** âœ… å·²ä¿®å¤

---

## ğŸ› é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯
```
PUT http://localhost:5173/api/orders/order_1/cancel 404 (Not Found)
è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨
å–æ¶ˆè®¢å•å¤±è´¥: AxiosError
```

### é—®é¢˜è¡¨ç°
- ç‚¹å‡»"å–æ¶ˆè®¢å•"æŒ‰é’®
- è¿”å›404é”™è¯¯
- è®¢å•æ— æ³•å–æ¶ˆ

---

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

**Mockä¸­ç¼ºå°‘å–æ¶ˆè®¢å•çš„APIæ¥å£**

#### å‰ç«¯è°ƒç”¨
```typescript
// src/api/order.ts
cancelOrder(orderId: string): Promise<ApiResponse<any>> {
  return request.put(`/orders/${orderId}/cancel`)
}
```

#### Mocké…ç½®
```typescript
// mock-data.ts
// âŒ æ²¡æœ‰å¤„ç† /api/orders/:id/cancel çš„æ¥å£
```

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ·»åŠ å–æ¶ˆè®¢å•Mockæ¥å£

**æ–‡ä»¶:** `mock-data.ts`

```typescript
// å–æ¶ˆè®¢å•
if (pathname?.includes('/cancel') && req.method === 'PUT') {
  const orderId = pathname.split('/')[3]
  const order = orders.find(o => o.id === orderId)

  if (!order) {
    res.setHeader('Content-Type', 'application/json')
    res.end(JSON.stringify({
      code: 404,
      message: 'è®¢å•ä¸å­˜åœ¨',
      success: false,
      data: null
    }))
    return true
  }

  // æ£€æŸ¥è®¢å•çŠ¶æ€æ˜¯å¦å¯ä»¥å–æ¶ˆ
  if (order.status !== 1 && order.status !== 2) {
    res.setHeader('Content-Type', 'application/json')
    res.end(JSON.stringify({
      code: 400,
      message: 'è¯¥è®¢å•çŠ¶æ€ä¸å…è®¸å–æ¶ˆ',
      success: false,
      data: null
    }))
    return true
  }

  // æ¨¡æ‹Ÿå–æ¶ˆè®¢å•
  order.status = 4 // 4: å·²å–æ¶ˆ
  order.cancelTime = new Date().toISOString()

  console.log('âœ… è®¢å•å·²å–æ¶ˆ:', order)

  res.setHeader('Content-Type', 'application/json')
  res.end(JSON.stringify({
    code: 200,
    message: 'è®¢å•å–æ¶ˆæˆåŠŸ',
    success: true,
    data: {
      orderId: order.id,
      orderNo: order.orderNo,
      cancelTime: order.cancelTime
    }
  }))
  return true
}
```

---

## ğŸ“Š åŠŸèƒ½ç‰¹ç‚¹

### 1. è®¢å•å­˜åœ¨æ€§æ£€æŸ¥
```typescript
if (!order) {
  return { code: 404, message: 'è®¢å•ä¸å­˜åœ¨' }
}
```

### 2. è®¢å•çŠ¶æ€éªŒè¯
```typescript
// åªæœ‰å¾…æ”¯ä»˜(1)å’Œå·²æ”¯ä»˜(2)çš„è®¢å•å¯ä»¥å–æ¶ˆ
if (order.status !== 1 && order.status !== 2) {
  return { code: 400, message: 'è¯¥è®¢å•çŠ¶æ€ä¸å…è®¸å–æ¶ˆ' }
}
```

### 3. çŠ¶æ€æ›´æ–°
```typescript
order.status = 4 // 4: å·²å–æ¶ˆ
order.cancelTime = new Date().toISOString()
```

### 4. æ—¥å¿—è®°å½•
```typescript
console.log('âœ… è®¢å•å·²å–æ¶ˆ:', order)
```

---

## ğŸ¯ ä¸šåŠ¡é€»è¾‘

### è®¢å•çŠ¶æ€æµè½¬

```
åˆ›å»ºè®¢å• (status: 1 å¾…æ”¯ä»˜)
  â†“
  â”œâ”€â†’ æ”¯ä»˜è®¢å• (status: 2 å·²æ”¯ä»˜)
  â”‚     â†“
  â”‚     â”œâ”€â†’ å®Œæˆè®¢å• (status: 3 å·²å®Œæˆ)
  â”‚     â””â”€â†’ å–æ¶ˆè®¢å• (status: 4 å·²å–æ¶ˆ) âœ…
  â”‚
  â””â”€â†’ å–æ¶ˆè®¢å• (status: 4 å·²å–æ¶ˆ) âœ…
```

### å¯å–æ¶ˆçŠ¶æ€
- âœ… **å¾…æ”¯ä»˜** (status: 1) - å¯ä»¥å–æ¶ˆ
- âœ… **å·²æ”¯ä»˜** (status: 2) - å¯ä»¥å–æ¶ˆ
- âŒ **å·²å®Œæˆ** (status: 3) - ä¸å¯å–æ¶ˆ
- âŒ **å·²å–æ¶ˆ** (status: 4) - ä¸å¯å–æ¶ˆ

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### æµ‹è¯•ç”¨ä¾‹1: å–æ¶ˆå¾…æ”¯ä»˜è®¢å•
**æ­¥éª¤:**
1. åˆ›å»ºä¸€ä¸ªæ–°è®¢å•(å¾…æ”¯ä»˜çŠ¶æ€)
2. ç‚¹å‡»"å–æ¶ˆè®¢å•"æŒ‰é’®
3. ç¡®è®¤å–æ¶ˆæ“ä½œ

**é¢„æœŸç»“æœ:** 
- âœ… è®¢å•çŠ¶æ€å˜ä¸º"å·²å–æ¶ˆ"
- âœ… æ˜¾ç¤ºå–æ¶ˆæˆåŠŸæç¤º
- âœ… è®¢å•åˆ—è¡¨æ›´æ–°

---

### æµ‹è¯•ç”¨ä¾‹2: å–æ¶ˆå·²æ”¯ä»˜è®¢å•
**æ­¥éª¤:**
1. åˆ›å»ºè®¢å•å¹¶å®Œæˆæ”¯ä»˜
2. ç‚¹å‡»"å–æ¶ˆè®¢å•"æŒ‰é’®
3. ç¡®è®¤å–æ¶ˆæ“ä½œ

**é¢„æœŸç»“æœ:** 
- âœ… è®¢å•çŠ¶æ€å˜ä¸º"å·²å–æ¶ˆ"
- âœ… æ˜¾ç¤ºå–æ¶ˆæˆåŠŸæç¤º
- âœ… å¯èƒ½æ¶‰åŠé€€æ¬¾æµç¨‹

---

### æµ‹è¯•ç”¨ä¾‹3: å–æ¶ˆå·²å®Œæˆè®¢å•
**æ­¥éª¤:**
1. å°è¯•å–æ¶ˆå·²å®Œæˆçš„è®¢å•
2. ç‚¹å‡»"å–æ¶ˆè®¢å•"æŒ‰é’®

**é¢„æœŸç»“æœ:** 
- âœ… æ˜¾ç¤ºé”™è¯¯æç¤º"è¯¥è®¢å•çŠ¶æ€ä¸å…è®¸å–æ¶ˆ"
- âœ… è®¢å•çŠ¶æ€ä¸å˜

---

### æµ‹è¯•ç”¨ä¾‹4: å–æ¶ˆä¸å­˜åœ¨çš„è®¢å•
**æ­¥éª¤:**
1. ä½¿ç”¨ä¸å­˜åœ¨çš„è®¢å•IDè°ƒç”¨å–æ¶ˆæ¥å£

**é¢„æœŸç»“æœ:** 
- âœ… è¿”å›404é”™è¯¯
- âœ… æ˜¾ç¤º"è®¢å•ä¸å­˜åœ¨"æç¤º

---

## ğŸ“ APIæ–‡æ¡£

### å–æ¶ˆè®¢å•

**æ¥å£:** `PUT /api/orders/:id/cancel`

**è¯·æ±‚å‚æ•°:**
- `id` (è·¯å¾„å‚æ•°): è®¢å•ID

**å“åº”æ ¼å¼:**

#### æˆåŠŸå“åº”
```json
{
  "code": 200,
  "message": "è®¢å•å–æ¶ˆæˆåŠŸ",
  "success": true,
  "data": {
    "orderId": "order_1",
    "orderNo": "20251110162523",
    "cancelTime": "2025-11-10T05:30:00.000Z"
  }
}
```

#### è®¢å•ä¸å­˜åœ¨
```json
{
  "code": 404,
  "message": "è®¢å•ä¸å­˜åœ¨",
  "success": false,
  "data": null
}
```

#### çŠ¶æ€ä¸å…è®¸å–æ¶ˆ
```json
{
  "code": 400,
  "message": "è¯¥è®¢å•çŠ¶æ€ä¸å…è®¸å–æ¶ˆ",
  "success": false,
  "data": null
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. è®¢å•çŠ¶æ€æ£€æŸ¥
```typescript
// âœ… æ­£ç¡® - æ£€æŸ¥çŠ¶æ€
if (order.status !== 1 && order.status !== 2) {
  return error('ä¸å…è®¸å–æ¶ˆ')
}

// âŒ é”™è¯¯ - ä¸æ£€æŸ¥çŠ¶æ€
order.status = 4  // ç›´æ¥ä¿®æ”¹
```

### 2. å–æ¶ˆæ—¶é—´è®°å½•
```typescript
// âœ… æ­£ç¡® - è®°å½•å–æ¶ˆæ—¶é—´
order.cancelTime = new Date().toISOString()

// âŒ é”™è¯¯ - ä¸è®°å½•æ—¶é—´
order.status = 4
```

### 3. è¿”å›ä¿¡æ¯å®Œæ•´
```typescript
// âœ… æ­£ç¡® - è¿”å›å®Œæ•´ä¿¡æ¯
data: {
  orderId: order.id,
  orderNo: order.orderNo,
  cancelTime: order.cancelTime
}

// âŒ é”™è¯¯ - ä¿¡æ¯ä¸å®Œæ•´
data: { orderId: order.id }
```

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ–
1. **æ·»åŠ å–æ¶ˆåŸå› **
   ```typescript
   interface CancelRequest {
     reason: string  // å–æ¶ˆåŸå› 
   }
   
   order.cancelReason = data.reason
   ```

2. **é€€æ¬¾å¤„ç†**
   ```typescript
   if (order.status === 2) {  // å·²æ”¯ä»˜
     // å¤„ç†é€€æ¬¾é€»è¾‘
     order.refundAmount = order.totalPrice
     order.refundStatus = 'pending'
   }
   ```

3. **å–æ¶ˆç¡®è®¤å¼¹çª—**
   ```vue
   <ConfirmDialog
     title="ç¡®è®¤å–æ¶ˆè®¢å•?"
     message="å–æ¶ˆåå°†æ— æ³•æ¢å¤,ç¡®å®šè¦å–æ¶ˆå—?"
     @confirm="cancelOrder"
   />
   ```

### ä¸­æœŸä¼˜åŒ–
1. **å–æ¶ˆè§„åˆ™é…ç½®**
   ```typescript
   const cancelRules = {
     pending: true,      // å¾…æ”¯ä»˜å¯å–æ¶ˆ
     paid: true,         // å·²æ”¯ä»˜å¯å–æ¶ˆ
     completed: false,   // å·²å®Œæˆä¸å¯å–æ¶ˆ
     cancelled: false    // å·²å–æ¶ˆä¸å¯å–æ¶ˆ
   }
   ```

2. **å–æ¶ˆæ—¶é™**
   ```typescript
   // èµ·é£å‰2å°æ—¶ä¸å…è®¸å–æ¶ˆ
   const departureTime = new Date(order.departureTime)
   const now = new Date()
   const hoursBeforeDeparture = (departureTime - now) / (1000 * 60 * 60)
   
   if (hoursBeforeDeparture < 2) {
     return error('èµ·é£å‰2å°æ—¶ä¸å…è®¸å–æ¶ˆ')
   }
   ```

3. **å–æ¶ˆæ‰‹ç»­è´¹**
   ```typescript
   // æ ¹æ®å–æ¶ˆæ—¶é—´è®¡ç®—æ‰‹ç»­è´¹
   const fee = calculateCancellationFee(order, cancelTime)
   order.cancellationFee = fee
   order.refundAmount = order.totalPrice - fee
   ```

---

## ğŸ“š ç›¸å…³æ¥å£

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|------|------|
| åˆ›å»ºè®¢å• | POST | /api/orders | åˆ›å»ºæ–°è®¢å• | âœ… |
| è·å–è®¢å•åˆ—è¡¨ | GET | /api/orders | æŸ¥è¯¢è®¢å•åˆ—è¡¨ | âœ… |
| è·å–è®¢å•è¯¦æƒ… | GET | /api/orders/:id | æŸ¥è¯¢è®¢å•è¯¦æƒ… | âœ… |
| æ”¯ä»˜è®¢å• | PUT | /api/orders/:id/pay | æ”¯ä»˜è®¢å• | âœ… |
| å–æ¶ˆè®¢å• | PUT | /api/orders/:id/cancel | å–æ¶ˆè®¢å• | âœ… |

---

## âœ… éªŒè¯æ¸…å•

- [x] æ·»åŠ å–æ¶ˆè®¢å•Mockæ¥å£
- [x] è®¢å•å­˜åœ¨æ€§æ£€æŸ¥
- [x] è®¢å•çŠ¶æ€éªŒè¯
- [x] çŠ¶æ€æ›´æ–°é€»è¾‘
- [x] å–æ¶ˆæ—¶é—´è®°å½•
- [x] æ—¥å¿—è®°å½•
- [x] é”™è¯¯å¤„ç†
- [ ] åŠŸèƒ½æµ‹è¯•é€šè¿‡(å¾…ç”¨æˆ·æµ‹è¯•)
- [ ] ä¸åŒçŠ¶æ€è®¢å•æµ‹è¯•
- [ ] è¾¹ç•Œæƒ…å†µæµ‹è¯•

---

## ğŸ‰ æ€»ç»“

**é—®é¢˜:** Mockä¸­ç¼ºå°‘å–æ¶ˆè®¢å•çš„APIæ¥å£

**ä¿®å¤:** æ·»åŠ  `PUT /api/orders/:id/cancel` æ¥å£

**åŠŸèƒ½ç‰¹ç‚¹:**
1. âœ… è®¢å•å­˜åœ¨æ€§æ£€æŸ¥
2. âœ… è®¢å•çŠ¶æ€éªŒè¯(åªå…è®¸å¾…æ”¯ä»˜å’Œå·²æ”¯ä»˜çŠ¶æ€å–æ¶ˆ)
3. âœ… çŠ¶æ€æ›´æ–°ä¸ºå·²å–æ¶ˆ
4. âœ… è®°å½•å–æ¶ˆæ—¶é—´
5. âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†

**æ ¸å¿ƒç»éªŒ:**
- ğŸ” Mockæ¥å£è¦è¦†ç›–æ‰€æœ‰å‰ç«¯è°ƒç”¨çš„API
- ğŸ” ä¸šåŠ¡é€»è¾‘è¦ç¬¦åˆå®é™…éœ€æ±‚
- ğŸ” çŠ¶æ€éªŒè¯å¾ˆé‡è¦,é˜²æ­¢éæ³•æ“ä½œ
- ğŸ” è®°å½•æ“ä½œæ—¶é—´ä¾¿äºè¿½è¸ª

---

**ä¿®å¤å®Œæˆæ—¶é—´:** 2025-11-10 05:32  
**ä¿®å¤è€…:** Cascade AI  
**BugçŠ¶æ€:** âœ… å·²ä¿®å¤,å¾…æµ‹è¯•éªŒè¯

---

## ğŸŠ æµ‹è¯•å»ºè®®

è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æµ‹è¯•:

1. **åˆ·æ–°æµè§ˆå™¨** (Ctrl+F5)
2. **åˆ›å»ºä¸€ä¸ªæ–°è®¢å•** (æˆ–ä½¿ç”¨ç°æœ‰è®¢å•)
3. **ç‚¹å‡»"å–æ¶ˆè®¢å•"æŒ‰é’®**
4. **ç¡®è®¤å–æ¶ˆæ“ä½œ**
5. **æŸ¥çœ‹è®¢å•çŠ¶æ€** - åº”è¯¥å˜ä¸º"å·²å–æ¶ˆ"
6. **æŸ¥çœ‹æ§åˆ¶å°** - åº”è¯¥çœ‹åˆ°"âœ… è®¢å•å·²å–æ¶ˆ"æ—¥å¿—

å–æ¶ˆè®¢å•åŠŸèƒ½ç°åœ¨åº”è¯¥æ­£å¸¸å·¥ä½œäº†! ğŸ’ª
