# 403 æƒé™é”™è¯¯ä¿®å¤è¯´æ˜

**é—®é¢˜æ—¶é—´:** 2025-11-11  
**çŠ¶æ€:** âœ… å·²ä¿®å¤

---

## ğŸ› é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯

```
:5173/api/messages/unread-count:1   Failed to load resource: the server responded with a status of 403 (Forbidden)
client.ts:46  æ²¡æœ‰æƒé™è®¿é—®
```

### é—®é¢˜åŸå› 

1. **æœªç™»å½•æ—¶è°ƒç”¨éœ€è¦è®¤è¯çš„API**
   - `MessageNotification` ç»„ä»¶åœ¨é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è½®è¯¢æœªè¯»æ¶ˆæ¯æ•°
   - æœªç™»å½•ç”¨æˆ·æ²¡æœ‰ tokenï¼Œåç«¯è¿”å› 403 é”™è¯¯

2. **Proxy é…ç½®æœªæ˜¾ç¤º**
   - æ§åˆ¶å°æ²¡æœ‰æ˜¾ç¤º "proxy é…ç½®å·²å¯ç”¨" çš„æ—¥å¿—
   - éœ€è¦æ·»åŠ æ˜ç¡®çš„æ—¥å¿—è¾“å‡º

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ 1: æ·»åŠ ç™»å½•çŠ¶æ€æ£€æŸ¥

**ä¿®æ”¹æ–‡ä»¶:** `src/stores/message.ts`

```typescript
const fetchUnreadCount = async () => {
  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
  const token = localStorage.getItem('token')
  if (!token) {
    // æœªç™»å½•æ—¶ä¸è°ƒç”¨APIï¼Œé¿å…403é”™è¯¯
    unreadCount.value = 0
    return
  }
  
  try {
    const response = await messageApi.getUnreadCount()
    if (response.success && response.data !== undefined) {
      unreadCount.value = response.data
    }
  } catch (error) {
    console.error('è·å–æœªè¯»æ¶ˆæ¯æ•°å¤±è´¥:', error)
    // å¦‚æœæ˜¯401æˆ–403é”™è¯¯ï¼Œè¯´æ˜æœªç™»å½•æˆ–æ— æƒé™ï¼Œè®¾ç½®ä¸º0
    unreadCount.value = 0
  }
}
```

**æ•ˆæœ:**
- âœ… æœªç™»å½•æ—¶ä¸ä¼šè°ƒç”¨æ¶ˆæ¯API
- âœ… é¿å… 403 é”™è¯¯
- âœ… ç™»å½•åæ­£å¸¸è·å–æœªè¯»æ¶ˆæ¯æ•°

### ä¿®å¤ 2: æ·»åŠ  Proxy çŠ¶æ€æ—¥å¿—

**ä¿®æ”¹æ–‡ä»¶:** `vite.config.ts`

```typescript
console.log('=== Vite é…ç½® ===')
console.log('æ¨¡å¼:', mode)
console.log('å‘½ä»¤:', command)
console.log('VITE_USE_MOCK:', env.VITE_USE_MOCK)
console.log('useMock:', useMock)
console.log('proxy é…ç½®å·²å¯ç”¨:', !useMock)  // æ–°å¢
```

**æ•ˆæœ:**
- âœ… æ˜ç¡®æ˜¾ç¤º proxy æ˜¯å¦å¯ç”¨
- âœ… æ–¹ä¾¿è°ƒè¯•å’Œç¡®è®¤é…ç½®

### ä¿®å¤ 3: åˆ›å»º .bat å¯åŠ¨è„šæœ¬

**æ–°å¢æ–‡ä»¶:**
- `seu-airline-vue/start-frontend.bat`
- `seu-airline-backend/start-backend.bat`

**åŸå› :**
- PowerShell è„šæœ¬ (.ps1) åœ¨æŸäº›ç»ˆç«¯ä¸æ”¯æŒ
- .bat è„šæœ¬å…¼å®¹æ€§æ›´å¥½

**ä½¿ç”¨æ–¹æ³•:**
```bash
# å¯åŠ¨å‰ç«¯
cd seu-airline-vue
start-frontend.bat

# å¯åŠ¨åç«¯
cd seu-airline-backend
start-backend.bat
```

---

## ğŸ§ª éªŒè¯æ­¥éª¤

### 1. é‡å¯å‰ç«¯æœåŠ¡

```bash
cd seu-airline-vue
npm run dev
```

**æ£€æŸ¥æ§åˆ¶å°è¾“å‡º:**
```
=== Vite é…ç½® ===
æ¨¡å¼: development
å‘½ä»¤: serve
VITE_USE_MOCK: false
useMock: false
proxy é…ç½®å·²å¯ç”¨: true  â† åº”è¯¥æ˜¾ç¤ºè¿™ä¸ª
```

### 2. æ‰“å¼€æµè§ˆå™¨

è®¿é—® http://localhost:5173/

**æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°:**
- âœ… ä¸åº”è¯¥å†æœ‰ 403 é”™è¯¯
- âœ… æœªç™»å½•æ—¶ä¸ä¼šè°ƒç”¨ `/api/messages/unread-count`

### 3. æµ‹è¯•ç™»å½•åçš„æ¶ˆæ¯åŠŸèƒ½

1. ç™»å½•è´¦å·
2. æŸ¥çœ‹æ¶ˆæ¯ä¸­å¿ƒ
3. æ£€æŸ¥æœªè¯»æ¶ˆæ¯æ•°æ˜¯å¦æ­£å¸¸æ˜¾ç¤º

---

## ğŸ“Š é—®é¢˜å½±å“èŒƒå›´

### å—å½±å“çš„ç»„ä»¶

1. **MessageNotification.vue**
   - æ¶ˆæ¯é€šçŸ¥ç»„ä»¶
   - è½®è¯¢æœªè¯»æ¶ˆæ¯æ•°

2. **MessageCenterPage.vue**
   - æ¶ˆæ¯ä¸­å¿ƒé¡µé¢
   - è·å–æ¶ˆæ¯åˆ—è¡¨å’Œæœªè¯»æ•°

### å—å½±å“çš„åŠŸèƒ½

- âœ… æœªè¯»æ¶ˆæ¯æ•°æ˜¾ç¤º
- âœ… æ¶ˆæ¯é€šçŸ¥
- âœ… æ¶ˆæ¯ä¸­å¿ƒ

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. API è°ƒç”¨å‰æ£€æŸ¥ç™»å½•çŠ¶æ€

```typescript
// âŒ é”™è¯¯åšæ³•
const fetchData = async () => {
  const response = await api.getData()
  // ç›´æ¥è°ƒç”¨ï¼Œå¯èƒ½å¯¼è‡´ 403
}

// âœ… æ­£ç¡®åšæ³•
const fetchData = async () => {
  const token = localStorage.getItem('token')
  if (!token) {
    // æœªç™»å½•ï¼Œä¸è°ƒç”¨API
    return
  }
  
  try {
    const response = await api.getData()
    // å¤„ç†æ•°æ®
  } catch (error) {
    // å¤„ç†é”™è¯¯
  }
}
```

### 2. ç»Ÿä¸€çš„é”™è¯¯å¤„ç†

åœ¨ `client.ts` ä¸­å·²ç»æœ‰ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ï¼š

```typescript
client.interceptors.response.use(
  (response) => response.data,
  (error) => {
    if (error.response) {
      const { status } = error.response
      switch (status) {
        case 401:
        case 403:
          // è‡ªåŠ¨æ¸…é™¤ token å¹¶è·³è½¬ç™»å½•
          localStorage.removeItem('token')
          window.location.href = '/login'
          break
      }
    }
    return Promise.reject(error)
  }
)
```

### 3. ç»„ä»¶ä¸­çš„æ¡ä»¶æ¸²æŸ“

```vue
<template>
  <!-- åªåœ¨ç™»å½•åæ˜¾ç¤ºæ¶ˆæ¯é€šçŸ¥ -->
  <MessageNotification v-if="isAuthenticated" />
</template>

<script setup>
import { computed } from 'vue'
import { useUserStore } from '@/stores/user'

const userStore = useUserStore()
const isAuthenticated = computed(() => userStore.isAuthenticated)
</script>
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æ£€æŸ¥ Token

```javascript
// æµè§ˆå™¨æ§åˆ¶å°
localStorage.getItem('token')
// åº”è¯¥è¿”å› JWT token æˆ– null
```

### 2. æ£€æŸ¥ API è¯·æ±‚

**F12 â†’ Network æ ‡ç­¾:**
- æŸ¥çœ‹è¯·æ±‚å¤´æ˜¯å¦åŒ…å« `Authorization: Bearer <token>`
- æŸ¥çœ‹å“åº”çŠ¶æ€ç 
- æŸ¥çœ‹å“åº”æ•°æ®

### 3. æ£€æŸ¥ Proxy é…ç½®

**å‰ç«¯æ§åˆ¶å°åº”è¯¥æ˜¾ç¤º:**
```
proxy é…ç½®å·²å¯ç”¨: true
```

**æµ‹è¯• Proxy:**
```bash
# ç›´æ¥è®¿é—®åç«¯
curl http://localhost:8080/api/airport/list

# é€šè¿‡å‰ç«¯ä»£ç†è®¿é—®
curl http://localhost:5173/api/airport/list
```

---

## ğŸ“ ç›¸å…³é—®é¢˜

### é—®é¢˜ #001: å­—æ®µåç§°ä¸åŒ¹é…
- çŠ¶æ€: âœ… å·²è§£å†³
- æ–‡æ¡£: `å‰åç«¯è¿æ¥é—®é¢˜è¿½è¸ª.md`

### é—®é¢˜ #002: Mock API å…¨å±€å˜é‡æ›¿æ¢
- çŠ¶æ€: âœ… å·²è§£å†³
- æ–‡æ¡£: `å‰åç«¯è¿æ¥é—®é¢˜è¿½è¸ª.md`

### é—®é¢˜ #003: 403 æƒé™é”™è¯¯
- çŠ¶æ€: âœ… å·²è§£å†³
- æ–‡æ¡£: æœ¬æ–‡æ¡£

---

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ·»åŠ å…¨å±€ç™»å½•çŠ¶æ€å®ˆå«

åœ¨è·¯ç”±é…ç½®ä¸­æ·»åŠ ï¼š

```typescript
router.beforeEach((to, from, next) => {
  const token = localStorage.getItem('token')
  
  // éœ€è¦ç™»å½•çš„é¡µé¢
  if (to.meta.requiresAuth && !token) {
    next('/login')
    return
  }
  
  next()
})
```

### 2. ä¼˜åŒ–æ¶ˆæ¯è½®è¯¢ç­–ç•¥

```typescript
// åªåœ¨ç™»å½•åå¯åŠ¨è½®è¯¢
watch(() => userStore.isAuthenticated, (isAuth) => {
  if (isAuth) {
    startPolling()
  } else {
    stopPolling()
  }
})
```

### 3. æ·»åŠ  Token è¿‡æœŸå¤„ç†

```typescript
// å®šæœŸæ£€æŸ¥ token æ˜¯å¦è¿‡æœŸ
setInterval(() => {
  const token = localStorage.getItem('token')
  if (token && isTokenExpired(token)) {
    // åˆ·æ–° token æˆ–è·³è½¬ç™»å½•
    refreshToken()
  }
}, 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
```

---

**æ–‡æ¡£ç»´æŠ¤è€…:** SEUAirline å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°:** 2025-11-11  
**çŠ¶æ€:** ğŸŸ¢ é—®é¢˜å·²è§£å†³
