# 前后端连接问题追踪

**创建时间:** 2025-11-11  
**用途:** 记录前后端连接过程中发现的问题及解决方案

---

## 📋 问题列表

### 问题 #001: 字段名称不匹配

**发现时间:** 2025-11-11  
**严重程度:** 🟡 中等  
**状态:** ✅ 已解决

**问题描述:**
- 前端使用 `realName` 字段
- 后端使用 `fullName` 字段
- 导致用户注册时真实姓名无法正确传递

**影响范围:**
- 用户注册功能
- 用户资料显示
- 个人中心页面

**解决方案:**
1. 在前端 `User` 接口中同时支持 `fullName` 和 `realName`
2. 在 `userApi.register()` 中将 `realName` 映射为 `fullName`
3. 保持向后兼容性

**修改文件:**
- `src/types/user.ts` - 添加 `fullName` 字段
- `src/api/user.ts` - 已有映射逻辑

**验证方法:**
```javascript
// 注册时检查请求参数
{
  "username": "testuser",
  "password": "123456",
  "email": "test@example.com",
  "phone": "13800138000",
  "fullName": "测试用户"  // 应该是 fullName
}
```

---

### 问题 #002: Mock API 全局变量替换问题

**发现时间:** 2025-11-11  
**严重程度:** 🔴 高  
**状态:** ✅ 已解决

**问题描述:**
- 之前使用全局变量替换 API 方式
- 切换到真实后端时可能出现问题
- 需要确保 Mock 完全关闭

**解决方案:**
1. 使用环境变量 `VITE_USE_MOCK` 控制
2. 在 `vite.config.ts` 中根据环境变量决定是否启用 Mock 插件
3. 关闭 Mock 后自动启用 proxy 代理

**修改文件:**
- `.env.development` - 设置 `VITE_USE_MOCK=false`
- `vite.config.ts` - 已有条件判断逻辑

**验证方法:**
```bash
# 启动前端时检查控制台输出
# 应该显示: useMock: false
# 应该显示: proxy 配置已启用
```

---

### 问题 #003: 未登录时调用需要认证的API导致403错误

**发现时间:** 2025-11-11  
**严重程度:** 🟡 中等  
**状态:** ✅ 已解决

**问题描述:**
- 页面加载时 `MessageNotification` 组件自动轮询未读消息数
- 未登录用户没有 token，后端返回 403 Forbidden
- 控制台显示错误: "没有权限访问"

**影响范围:**
- 所有未登录用户访问首页
- 消息通知功能
- 控制台错误日志

**解决方案:**
1. 在 `fetchUnreadCount()` 方法中添加登录状态检查
2. 未登录时不调用 API，直接设置未读数为 0
3. 捕获 403 错误并优雅处理

**修改文件:**
- `src/stores/message.ts` - 添加 token 检查

**验证方法:**
```javascript
// 未登录时访问首页
// 控制台不应该有 403 错误
// 登录后应该正常显示未读消息数
```

**详细文档:** `403错误修复说明.md`

---

### 问题 #004: 待发现

**状态:** ⏳ 待测试

**可能的问题:**
- [ ] CORS 跨域问题
- [ ] 日期格式不匹配
- [ ] 响应数据结构差异
- [ ] 分页参数不一致

---

## 🔍 调试检查清单

### 用户注册/登录

- [x] 字段名称匹配 (fullName vs realName)
- [ ] 密码加密方式一致
- [ ] Token 格式正确
- [ ] 响应数据包含 user 和 token
- [ ] localStorage 正确保存

### 航班搜索

- [ ] 日期格式: YYYY-MM-DD
- [ ] 城市名称匹配
- [ ] 响应数据结构匹配
- [ ] 航班ID类型 (string vs number)

### 机场列表

- [ ] 响应格式: {success, data, message}
- [ ] 数据数组结构
- [ ] 字段名称匹配

---

## 📝 字段映射表

### User 对象

| 前端字段 | 后端字段 | 类型 | 说明 |
|---------|---------|------|------|
| id | id | number/string | 用户ID |
| username | username | string | 用户名 |
| email | email | string | 邮箱 |
| phone | phone | string | 手机号 |
| fullName | fullName | string | 真实姓名 |
| realName | - | string | 兼容字段 |
| role | role | string | 角色 |
| vipLevel | vipLevel | number | VIP等级 |
| points | points | number | 积分 |
| createdAt | createdAt | string | 创建时间 |

### Flight 对象

| 前端字段 | 后端字段 | 类型 | 说明 |
|---------|---------|------|------|
| id | id | string/number | 航班ID |
| flightNo | flightNumber | string | 航班号 |
| departureCity | departureCity | string | 出发城市 |
| arrivalCity | arrivalCity | string | 到达城市 |
| departureTime | departureTime | string | 出发时间 |
| arrivalTime | arrivalTime | string | 到达时间 |
| price | price | number | 价格 |

### Airport 对象

| 前端字段 | 后端字段 | 类型 | 说明 |
|---------|---------|------|------|
| code | code | string | 机场代码 |
| name | name | string | 机场名称 |
| city | city | string | 城市 |
| country | country | string | 国家 |

---

## 🎯 下一步行动

### 立即执行

1. **启动后端服务**
   ```bash
   cd seu-airline-backend
   .\start-backend.ps1
   ```

2. **运行API测试**
   ```bash
   cd ..
   .\test-api-connection.ps1
   ```

3. **启动前端服务**
   ```bash
   cd seu-airline-vue
   .\start-frontend.ps1
   ```

### 测试流程

1. **基础功能测试**
   - [ ] 用户注册
   - [ ] 用户登录
   - [ ] 获取机场列表
   - [ ] 搜索航班

2. **错误处理测试**
   - [ ] 无效的登录凭证
   - [ ] 重复的用户名
   - [ ] 网络错误处理
   - [ ] Token 过期处理

3. **数据一致性测试**
   - [ ] 注册后的用户信息
   - [ ] 航班搜索结果
   - [ ] 订单数据

---

## 📊 测试记录

### 测试 #001: 用户注册

**时间:** 待测试  
**测试人员:** -  
**结果:** ⏳ 待测试

**测试步骤:**
1. 打开注册页面
2. 填写注册信息
3. 提交注册
4. 检查响应数据
5. 验证登录状态

**预期结果:**
- 注册成功
- 返回 user 和 token
- 自动登录
- localStorage 保存数据

**实际结果:**
- 待测试

**问题记录:**
- 无

---

### 测试 #002: 用户登录

**时间:** 待测试  
**测试人员:** -  
**结果:** ⏳ 待测试

**测试数据:**
```json
{
  "username": "admin",
  "password": "admin123"
}
```

**预期结果:**
- 登录成功
- 返回 token
- 跳转首页

**实际结果:**
- 待测试

---

### 测试 #003: 机场列表

**时间:** 待测试  
**测试人员:** -  
**结果:** ⏳ 待测试

**API:** `GET /api/airport/list`

**预期结果:**
```json
{
  "success": true,
  "data": [
    {
      "code": "NKG",
      "name": "南京禄口国际机场",
      "city": "南京",
      "country": "中国"
    }
  ]
}
```

**实际结果:**
- 待测试

---

## 💡 经验总结

### 成功经验

1. **环境变量控制**
   - 使用 `VITE_USE_MOCK` 灵活切换模式
   - 避免代码中硬编码

2. **字段兼容性**
   - 同时支持新旧字段名
   - 保持向后兼容

3. **启动脚本**
   - 自动检查环境
   - 减少人为错误

### 待改进

1. **类型定义**
   - 前后端类型定义需要更一致
   - 考虑使用共享类型定义

2. **错误处理**
   - 需要更详细的错误信息
   - 统一错误码

3. **文档同步**
   - API 文档需要及时更新
   - 字段映射表需要维护

---

**文档维护者:** SEUAirline 开发团队  
**最后更新:** 2025-11-11  
**状态:** 🟢 活跃维护中
