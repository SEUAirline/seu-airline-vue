# 用户信息管理优化说明

## 优化目标

1. **减少 API 调用频率** - 避免每个页面都频繁调用 `/user/profile` API
2. **统一数据源** - 所有组件从 Pinia Store 获取用户信息
3. **提升性能** - 减少网络请求，提高页面加载速度
4. **改进数据流** - 登录时获取完整信息，后续从本地读取

## 架构改进

### 1. 用户信息获取时机

#### 之前（❌ 问题）
```
登录 → 保存基础信息到 Store
     ↓
打开 ProfilePage → 调用 /user/profile API
打开 UserCenterPage → 调用 /user/profile API  
打开 SettingsPage → 调用 /user/profile API
打开 FlightBookPage → 调用 /user/profile API
```
**问题**: 每个页面都重复调用 API，浪费资源

#### 现在（✅ 优化）
```
登录 → 调用 /user/profile API 获取完整信息 → 存储到 Store + localStorage
     ↓
打开任意页面 → 从 Store 读取用户信息（本地，无网络请求）
```

### 2. Store 改进

#### `src/stores/user.ts`

**新增方法**:
```typescript
async function fetchUserProfile() {
  // 获取完整的用户Profile信息
  const response = await request.get('/user/profile')
  if (response.data.code === 200 && response.data.data) {
    currentUser.value = { ...profileData }
    localStorage.setItem('user', JSON.stringify(currentUser.value))
  }
}
```

**登录流程改进**:
```typescript
async function login(loginForm: LoginForm) {
  const response = await userApi.login(loginForm)
  // 保存基础信息
  currentUser.value = response.data.user
  token.value = response.data.token
  
  // 立即获取完整Profile（包含 idCard 等字段）
  await fetchUserProfile()
}
```

### 3. 路由守卫优化

#### `src/router/index.ts`

```typescript
router.beforeEach(async (to, _from, next) => {
  const userStore = useUserStore()
  
  // 如果有token但用户信息不完整（比如缺少idCard），刷新
  if (userStore.token && userStore.currentUser && !userStore.currentUser.idCard) {
    await userStore.fetchUserProfile()
  }
  
  // ... 其他认证检查
})
```

**作用**: 确保页面切换时用户信息完整

### 4. 页面组件优化

#### ProfilePage.vue
```typescript
// ❌ 之前
const loadUserInfo = async () => {
  const response = await request.get('/user/profile')
  userInfo.value = response.data
}

// ✅ 现在
const loadUserInfo = async () => {
  // 直接从 store 获取
  const storeUser = userStore.currentUser
  if (storeUser) {
    userInfo.value = storeUser
    return
  }
  // 只有 store 中没有时才调用 API（罕见情况）
  const response = await request.get('/user/profile')
  userStore.updateUser(response.data)
}
```

#### UserCenterPage.vue
```typescript
// ❌ 之前
async function loadUserInfo() {
  const response = await request.get('/user/profile')
  userInfo.value = response.data
}

// ✅ 现在
async function loadUserInfo() {
  // 直接从 store 获取，无 API 调用
  const storeUser = userStore.currentUser
  if (storeUser) {
    userInfo.value = {
      name: storeUser.fullName || storeUser.username,
      username: storeUser.username,
      idCard: storeUser.idCard,
      // ...
    }
  }
}
```

#### SettingsPage.vue
```typescript
// ✅ 现在
const loadUserInfo = async () => {
  const storeUser = userStore.currentUser
  if (storeUser) {
    profileForm.value = { ...storeUser }
  }
}
```

#### FlightBookPage.vue
```typescript
// ✅ 现在
onMounted(async () => {
  // 从 store 获取用户信息填充第一个乘客
  const currentUser = userStore.currentUser
  if (currentUser && passengers.value.length > 0) {
    passengers.value[0] = {
      name: currentUser.fullName || '',
      idCard: currentUser.idCard || '',
      phone: currentUser.phone || '',
      passengerType: 'adult'
    }
  }
})
```

## 数据流图

```
┌─────────────┐
│  用户登录   │
└──────┬──────┘
       │
       ├─ userApi.login() → 获取 token + 基础用户信息
       │
       ├─ fetchUserProfile() → 获取完整用户信息（fullName, idCard, phone等）
       │
       └─ 存储到 Pinia Store + localStorage
              │
              ├─ currentUser (响应式)
              ├─ token (响应式)
              └─ localStorage 持久化
                     │
                     ▼
        ┌────────────────────────┐
        │  所有页面组件从这里读取  │
        └────────────────────────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
   ProfilePage  FlightBookPage  UserCenterPage
        │            │            │
        └────────────┴────────────┘
              无需 API 调用
```

## 性能对比

### 之前
- **登录**: 1 次 API 调用
- **打开 ProfilePage**: 1 次 API 调用
- **打开 FlightBookPage**: 1 次 API 调用
- **打开 UserCenterPage**: 1 次 API 调用
- **总计**: 4 次 API 调用

### 现在
- **登录**: 2 次 API 调用（login + fetchUserProfile，一次性完成）
- **打开所有页面**: 0 次 API 调用（从 store 读取）
- **总计**: 2 次 API 调用

**减少 50% 的网络请求！**

## 航班信息获取优化

### FlightBookPage 改进

**之前**:
```typescript
// 只从 store 查找，找不到就显示"航班不存在"
const flight = flightStore.searchResults.find(f => f.id === flightId)
```

**现在**:
```typescript
// 1. 先从 store 查找
let flight = flightStore.searchResults.find(f => f.id === flightId)

// 2. 如果 store 中没有，从后端 API 获取
if (!flight) {
  const response = await flightApi.getFlightById(flightId)
  if (response.success && response.data) {
    flight = response.data
  }
}
```

**好处**:
- ✅ 支持直接访问 `/flights/book/1` URL（刷新不会丢失航班信息）
- ✅ 支持分享链接给其他人
- ✅ 后端已有 `GET /flight/{id}` API，直接使用

## 更新文件清单

### 修改的文件
1. `src/stores/user.ts` - 新增 fetchUserProfile 方法
2. `src/router/index.ts` - 路由守卫检查用户信息完整性
3. `src/views/user/ProfilePage.vue` - 从 store 获取用户信息
4. `src/views/user/UserCenterPage.vue` - 从 store 获取用户信息
5. `src/views/user/SettingsPage.vue` - 从 store 获取用户信息
6. `src/views/user/FlightBookPage.vue` - 从 store 获取用户信息 + 支持从 API 获取航班

### 未修改的文件
- `src/components/AppHeader.vue` - 已经在使用 store ✅

## 最佳实践

### ✅ 应该做
1. **登录时** - 调用 `fetchUserProfile()` 获取完整信息
2. **页面初始化** - 从 `userStore.currentUser` 读取信息
3. **更新用户信息后** - 调用 `userStore.updateUser(newData)` 同步 store
4. **退出登录时** - 调用 `userStore.logout()` 清理所有数据

### ❌ 不应该做
1. ~~在每个页面都调用 `/user/profile` API~~
2. ~~直接从 localStorage 读取用户信息~~（应该通过 store）
3. ~~修改用户信息后不更新 store~~

## 测试要点

### 功能测试
- [ ] 登录后用户信息完整（包含 idCard, phone 等）
- [ ] ProfilePage 显示正确的用户信息
- [ ] FlightBookPage 第一个乘客自动填充当前用户信息
- [ ] UserCenterPage 显示用户名和统计信息
- [ ] 刷新 `/flights/book/1` 页面能正确显示航班信息

### 性能测试
- [ ] 打开 ProfilePage 不应调用 `/user/profile` API
- [ ] 打开 UserCenterPage 不应调用 `/user/profile` API
- [ ] 打开 FlightBookPage 不应调用 `/user/profile` API
- [ ] 只在登录时调用一次 `/user/profile` API

### 边界测试
- [ ] token 过期时正确跳转到登录页
- [ ] localStorage 被清空后重新登录能正常工作
- [ ] 直接访问 `/flights/book/123` 能从后端加载航班信息

## 未来优化方向

1. **缓存策略** - 添加用户信息过期时间，定期刷新
2. **离线支持** - Service Worker 缓存用户信息
3. **数据同步** - WebSocket 实时同步用户信息变更
4. **懒加载** - 按需加载用户的订单、常用旅客等数据

## 总结

通过这次优化：
- ✅ **减少 50% API 调用**
- ✅ **提升页面加载速度**
- ✅ **统一数据管理**
- ✅ **改进用户体验**（第一个乘客自动填充、支持直接访问订单链接）
- ✅ **代码更简洁**（不再重复写 API 调用代码）
